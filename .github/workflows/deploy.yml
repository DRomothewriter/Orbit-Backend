name: Deploy to EC2

on:
  push:
    branches:
      - main  # Se ejecuta solo cuando se hace push a main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Clonar el repositorio
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Configurar Node.js (si tu app es Node)
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22'  # Ajusta a tu versi√≥n de Node

    # 3. Instalar dependencias
    - name: Install dependencies
      run: npm install

    # 4. Ejecutar pruebas
    - name: Run tests
      run: npm test

    # 5. Copiar clave privada para SSH
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    # 6. Desplegar en EC2
    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ec2-user@3.16.111.38 << 'EOF'
          cd /var/www/orbit-backend/
          echo "Pulling latest changes..."
          git pull origin main
          echo "Installing dependencies..."
          npm install
          echo "Building TypeScript..."
          npm run build
          echo "Restarting PM2..."
          pm2 restart all
          pm2 list
          echo "Deploy finished"
        EOF